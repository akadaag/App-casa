<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <title>Stato Casa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; background-color: #f0f2f5; }
        h1 { text-align: center; margin-bottom: 20px; color: #333; }
        .section { margin-bottom: 32px; }
        .card { padding: 16px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); background: #fff; }
        .titleRow { display: flex; justify-content: space-between; align-items: center; font-size: 20px; font-weight: bold; margin-bottom: 8px; color: #1a237e; }
        .edit-icon { border: none; background: none; font-size: 20px; cursor: pointer; padding: 5px; }
        .del-icon { background: none; border: none; font-size: 16px; cursor: pointer; color: #dc3545; float: right; }
        .status-free { color: #28a745; font-weight: bold; }
        .status-occupied { color: #dc3545; font-weight: bold; }
        .btn { width: 100%; padding: 13px; font-size: 17px; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        .btn-primary { background: #2196F3; color: #fff; }
        .btn-primary:hover { background: #1976D2; }
        .btn-secondary { background: #4caf50; color: #fff; }
        .btn-secondary:hover { background: #388E3C; }
        .btn-choice { background: #607d8b; color: #fff; margin-top: 8px; }
        .btn-choice:hover { background: #546E7A; }
        .btn-icon { background: none; border: none; font-size: 24px; cursor: pointer; margin-top: 10px; color: #2196F3; }
        .hidden { display: none; }
        input, select { width: calc(100% - 18px); padding: 8px; border-radius: 6px; border: 1px solid #ccc; margin: 5px 0; }
        .dayBlock { margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee; }
        .navRow { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    </style>
</head>

<body>
    <h1>Stato Casa</h1>

    <div class="section">
        <div id="bathroomSection"></div>
        <button id="useButton" class="btn btn-primary">Usa un bagno</button>
        <div id="choiceButtons" class="hidden"></div>
        <button id="freeButton" class="btn btn-secondary hidden">Ho finito</button>
    </div>

    <div class="section card">
        <div class="titleRow"><span>üçΩÔ∏è Menu</span><button id="menuEditIcon" class="edit-icon">‚úèÔ∏è</button></div>
        <div id="menuView"></div>
        <div id="menuEdit" class="hidden"></div>
        <button id="menuAddDay" class="btn-icon hidden">Ôºã Giorno</button>
        <button id="menuSave" class="btn btn-secondary hidden" style="margin-top: 10px;">Salva Menu</button>
    </div>

    <div class="section card">
        <div class="titleRow"><span>üßº Turni piatti</span><button id="turniEditIcon" class="edit-icon">‚úèÔ∏è</button></div>
        <div class="navRow">
            <button id="prevDay" class="edit-icon">‚óÄÔ∏è</button>
            <span id="currentDayTitle"></span>
            <button id="nextDay" class="edit-icon">‚ñ∂Ô∏è</button>
        </div>
        <div id="turniView"></div>
        <div id="turniEdit" class="hidden"></div>
        <button id="turniAddDay" class="btn-icon hidden">Ôºã Giorno</button>
        <button id="turniSave" class="btn btn-secondary hidden" style="margin-top: 10px;">Salva Turni</button>
    </div>

    <script>
        const PIN = '6789'; // Questo √® il nostro "user ID" e anche la password per le modifiche

        // --- FUNZIONI DI COMUNICAZIONE CON IL SERVER ---
        async function getState() {
            try {
                const response = await fetch('/api/state');
                if (!response.ok) { 
                    console.error("Errore dal server:", response.status);
                    return null; 
                }
                return response.json();
            } catch (e) {
                console.error("Errore di rete o fetch fallita:", e);
                return null;
            }
        }

        async function setState(data) {
            return fetch('/api/state', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        }

        // --- FUNZIONE PRINCIPALE DI RENDER ---
        async function render() {
            const state = await getState();
            if (!state) return;

            renderBagni(state);
            renderMenuView(state.menu);
            renderTurniView(state.turni);
        }

        // ----------- BAGNI ----------
        function renderBagni(state) {
            const cont = document.getElementById('bathroomSection');
            cont.innerHTML = '';
            ['sopra', 'sotto'].forEach(b => {
                const bagno = state[b] || { state: 'free' }; // Sicurezza nel caso la propriet√† manchi
                const occ = (bagno.state === 'occupied');
                cont.innerHTML += `<div class="card" style="margin-bottom:10px">üöΩ Bagno ${b} ‚Äî <span class="${occ ? 'status-occupied' : 'status-free'}">${occ ? 'Occupato' : 'Libero'}</span></div>`;
            });

            const useBtn = document.getElementById('useButton');
            const freeBtn = document.getElementById('freeButton');
            const choiceDiv = document.getElementById('choiceButtons');

            const myBathroom = ['sopra', 'sotto'].find(b => state[b] && state[b].state === 'occupied' && state[b].user === PIN);

            choiceDiv.classList.add('hidden');
            choiceDiv.innerHTML = '';

            if (myBathroom) {
                useBtn.classList.add('hidden');
                freeBtn.classList.remove('hidden');
                freeBtn.onclick = async () => {
                    await setState({ bagno: myBathroom, state: 'free', user: PIN });
                    render();
                };
            } else {
                freeBtn.classList.add('hidden');
                useBtn.classList.remove('hidden');
                useBtn.onclick = () => {
