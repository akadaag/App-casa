<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Stato Casa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body{font-family:Arial,sans-serif;max-width:600px;margin:auto;padding:20px;}
    h1{text-align:center;margin-bottom:20px;}
    .section{margin-bottom:32px;}
    .card{padding:16px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.15);background:#fff;}
    .titleRow{display:flex;justify-content:space-between;align-items:center;font-size:20px;font-weight:bold;margin-bottom:8px;}
    .edit-icon{border:none;background:none;font-size:20px;cursor:pointer;}
    .status-free{color:#28a745;font-weight:bold;}
    .status-occupied{color:#dc3545;font-weight:bold;}
    .btn{width:100%;padding:13px;font-size:17px;border:none;border-radius:8px;cursor:pointer;}
    .btn-primary{background:#2196F3;color:#fff;}
    .btn-secondary{background:#4caf50;color:#fff;}
    .btn-choice{background:#607d8b;color:#fff;margin-top:8px;}
    .btn-icon{background:none;border:none;font-size:24px;cursor:pointer;margin-top:10px;}
    .hidden{display:none;}
    input,select{width:100%;padding:8px;border-radius:6px;margin:5px 0;}
    .dayBlock{margin-top:12px;}
    .navRow{display:flex;justify-content:space-between;margin-bottom:6px;}
  </style>
</head>

<body>
<h1>Stato Casa</h1>

<div class="section">
  <div id="bathroomSection"></div>
  <button id="useButton" class="btn btn-primary">Usa un bagno</button>
  <div id="choiceButtons" class="hidden"></div>
  <button id="freeButton" class="btn btn-secondary hidden">Ho finito</button>
</div>

<div class="section card">
  <div class="titleRow"><span>üçΩÔ∏è Menu</span><button id="menuEditIcon" class="edit-icon">‚úèÔ∏è</button></div>
  <div id="menuView"></div>
  <div id="menuEdit" class="hidden"></div>
  <select id="menuSelect" class="hidden"></select>
  <button id="menuAddDay" class="btn-icon hidden">Ôºã</button>
  <button id="menuSave" class="btn btn-secondary hidden">Salva</button>
</div>

<div class="section card">
  <div class="titleRow">
    <span>üßº Turni piatti</span>
    <button id="turniEditIcon" class="edit-icon">‚úèÔ∏è</button>
  </div>
  <div class="navRow">
    <button id="prevDay" class="edit-icon">‚óÄÔ∏è</button>
    <span id="currentDayTitle"></span>
    <button id="nextDay" class="edit-icon">‚ñ∂Ô∏è</button>
  </div>
  <div id="turniView"></div>
  <div id="turniEdit" class="hidden"></div>
  <select id="turniSelect" class="hidden"></select>
  <button id="turniAddDay" class="btn-icon hidden">Ôºã</button>
  <button id="turniSave" class="btn btn-secondary hidden">Salva</button>
</div>
<script>
const PIN='6789';
const giorni=["Luned√¨","Marted√¨","Mercoled√¨","Gioved√¨","Venerd√¨","Sabato","Domenica"];

// üìÜ periodo vacanza fisso
const startDate = new Date("2025-08-17");
const endDate   = new Date("2025-08-29");

// inizializza la data corrente nel range
let currentDate = new Date();
if(currentDate < startDate) currentDate = new Date(startDate);
if(currentDate > endDate)   currentDate = new Date(endDate);

// indice per scorrere tra i giorni inseriti nei turni
let currentTurnoIndex = 0;

// Simulazione localStorage per l'ambiente Claude
const mockStorage = {};
const localStorage = {
  getItem: (key) => mockStorage[key] || null,
  setItem: (key, value) => mockStorage[key] = value
};

const localKey='bagno_app_user';
let userId=localStorage.getItem(localKey);
if(!userId){userId=Date.now()+Math.random();localStorage.setItem(localKey,userId);}

// Simulazione dell'API per l'ambiente Claude
let appState = {
  sopra: {state: 'free', user: null},
  sotto: {state: 'free', user: null},
  menu: {},
  turni: {}
};

async function getState(){
  return new Promise(resolve => {
    setTimeout(() => resolve(appState), 100);
  });
}

async function setState(o){
  return new Promise(resolve => {
    if(o.bagno) {
      if(o.state === 'occupied') {
        appState[o.bagno] = {state: 'occupied', user: o.user};
      } else {
        appState[o.bagno] = {state: 'free', user: null};
      }
    }
    if(o.menu) appState.menu = o.menu;
    if(o.turni) appState.turni = o.turni;
    setTimeout(() => resolve(), 100);
  });
}

async function render(){
 const d=await getState();
 renderBagni(d);
 renderMenuView(d.menu);
 renderTurniView(d.turni);
}

function renderBagni(d){
  const cont=document.getElementById('bathroomSection'); cont.innerHTML='';
  ['sopra','sotto'].forEach(b=>{
    const occ=(d[b].state==='occupied');
    cont.innerHTML+=`<div class="card" style="margin-bottom:10px">üöΩ Bagno ${b} ‚Äî <span class="${occ?'status-occupied':'status-free'}">${occ?'Occupato':'Libero'}</span></div>`;
  });
  const use=document.getElementById('useButton'),free=document.getElementById('freeButton'),ch=document.getElementById('choiceButtons');
  const myB=['sopra','sotto'].find(b=>d[b].state==='occupied'&&d[b].user===userId);
  ch.classList.add('hidden'); ch.innerHTML='';
  if(myB){
    use.classList.add('hidden'); free.classList.remove('hidden');
    free.onclick=async()=>{ await setState({bagno:myB,state:'free'}); render();}
  }else{
    free.classList.add('hidden'); use.classList.remove('hidden');
    use.onclick=()=>{
      const available=['sopra','sotto'].filter(b=>d[b].state==='free');
      if(!available.length){alert("Tutti occupati");return;}
      ch.classList.remove('hidden'); ch.innerHTML='Seleziona bagno:<br>';
      available.forEach(b=>{const bt=document.createElement('button');bt.className='btn btn-choice';bt.textContent=b;bt.onclick=async()=>{ await setState({bagno:b,state:'occupied'}); render(); };ch.appendChild(bt);});
    };
  }
}

function renderMenuView(menu){
  const view=document.getElementById('menuView'), icon=document.getElementById('menuEditIcon');
  view.innerHTML=menu?'':'(vuoto)';
  if(menu){Object.keys(menu).forEach(d=>{view.innerHTML+=`<div><strong>${d}</strong><br>‚Ä¢ Pranzo: ${menu[d].pranzo||'-'}<br>‚Ä¢ Cena: ${menu[d].cena||'-'}</div>`});}
  icon.onclick=()=>{if(prompt('PIN?')===PIN){openMenuEdit(menu||{});} };
}

function openMenuEdit(current){
  document.getElementById('menuView').classList.add('hidden');
  document.getElementById('menuEditIcon').classList.add('hidden');
  const edit=document.getElementById('menuEdit'), sel=document.getElementById('menuSelect'), add=document.getElementById('menuAddDay'), save=document.getElementById('menuSave');
  edit.innerHTML=''; sel.innerHTML=''; sel.classList.add('hidden');
  add.classList.remove('hidden'); save.classList.remove('hidden');

  Object.keys(current).forEach(d=>{
    const block=document.createElement('div'); block.className='dayBlock';
    const del=document.createElement('button'); del.className='del-icon'; del.textContent='üóëÔ∏è'; del.onclick=()=>{delete current[d]; openMenuEdit(current);}
    const p=document.createElement('input'); p.placeholder='Pranzo'; p.value=current[d].pranzo; p.oninput=e=>current[d].pranzo=e.target.value;
    const c=document.createElement('input'); c.placeholder='Cena'; c.value=current[d].cena; c.oninput=e=>current[d].cena=e.target.value;
    const title=document.createElement('div'); title.innerHTML=`<strong>${d}</strong>`; title.appendChild(del);
    block.appendChild(title); block.appendChild(p); block.appendChild(c);
    edit.appendChild(block);
  });

  add.onclick=()=>{
    sel.innerHTML="<option value=''>Seleziona giorno...</option>";
    giorni.forEach(g=>{const o=document.createElement('option');o.value=g;o.text=g;sel.appendChild(o);});
    sel.onchange=e=>{
      if(e.target.value){
        current[e.target.value]={pranzo:'',cena:''};
        sel.classList.add('hidden');
        add.classList.remove('hidden');
        openMenuEdit(current);
      }
    };
    sel.classList.remove('hidden');
    add.classList.add('hidden');
  };

  edit.classList.remove('hidden');
  save.onclick=async()=>{await setState({menu:current}); closeMenuEdit();}
}
function closeMenuEdit(){
  ['menuEdit','menuSave','menuSelect'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  document.getElementById('menuAddDay').classList.remove('hidden');
  document.getElementById('menuEditIcon').classList.remove('hidden');
  document.getElementById('menuView').classList.remove('hidden');
  render();
}

function renderTurniView(turni){
  const view=document.getElementById('turniView'),
        icon=document.getElementById('turniEditIcon'),
        navRow=document.querySelector('.navRow'),
        prevBtn=document.getElementById('prevDay'),
        nextBtn=document.getElementById('nextDay'),
        currentDayTitle=document.getElementById('currentDayTitle');

  const turniKeys = Object.keys(turni || {});
  
  view.innerHTML='';
  
  if(turniKeys.length === 0){
    // Nessun turno inserito
    view.innerHTML = 'Nessun turno inserito';
    navRow.style.display = 'none';
  } else if(turniKeys.length === 1){
    // Solo un turno inserito - mostra senza frecce
    const onlyKey = turniKeys[0];
    const t = turni[onlyKey];
    view.innerHTML = `<div><strong>${onlyKey}</strong><br>‚Ä¢ Pranzo: ${t.pranzo||'-'}<br>‚Ä¢ Cena: ${t.cena||'-'}</div>`;
    navRow.style.display = 'none';
  } else {
    // Pi√π turni inseriti - mostra con frecce per scorrere
    navRow.style.display = 'flex';
    
    // Assicurati che l'indice sia valido
    if(currentTurnoIndex >= turniKeys.length) currentTurnoIndex = 0;
    if(currentTurnoIndex < 0) currentTurnoIndex = turniKeys.length - 1;
    
    const currentKey = turniKeys[currentTurnoIndex];
    const t = turni[currentKey];
    
    view.innerHTML = `<div><strong>${currentKey}</strong><br>‚Ä¢ Pranzo: ${t.pranzo||'-'}<br>‚Ä¢ Cena: ${t.cena||'-'}</div>`;
    currentDayTitle.innerText = `${currentTurnoIndex + 1} di ${turniKeys.length}`;
    
    // Abilita/disabilita frecce
    prevBtn.disabled = false;
    nextBtn.disabled = false;
  }

  icon.onclick = ()=>{ 
    if(prompt('PIN?')===PIN){ 
      openTurniEdit(turni||{}); 
    }
  };
}

function openTurniEdit(current){
  document.getElementById('turniView').classList.add('hidden');
  document.getElementById('turniEditIcon').classList.add('hidden');
  const edit=document.getElementById('turniEdit'),
        sel=document.getElementById('turniSelect'),
        add=document.getElementById('turniAddDay'),
        save=document.getElementById('turniSave');
  edit.innerHTML=''; sel.innerHTML=''; sel.classList.add('hidden');
  add.classList.remove('hidden'); save.classList.remove('hidden');

  // pulsante + ‚Üí input manuale del giorno
  add.onclick=()=>{
    const dayInput = document.createElement('input');
    dayInput.placeholder = 'Scrivi il giorno (es: Luned√¨, Marted√¨...)';
    dayInput.style.marginBottom = '10px';
    
    const confirmBtn = document.createElement('button');
    confirmBtn.textContent = 'Aggiungi';
    confirmBtn.className = 'btn btn-secondary';
    confirmBtn.style.marginTop = '10px';
    confirmBtn.onclick = () => {
      const dayName = dayInput.value.trim();
      if(dayName) {
        // Usa il nome del giorno come chiave invece della data
        current[dayName] = {pranzo:'', cena:''};
        edit.removeChild(dayInput);
        edit.removeChild(confirmBtn);
        add.classList.remove('hidden');
        openTurniEdit(current);
      }
    };
    
    edit.appendChild(dayInput);
    edit.appendChild(confirmBtn);
    add.classList.add('hidden');
  };

  // mostra tutti i giorni presenti
  Object.keys(current).forEach(key=>{
    const block=document.createElement('div'); block.className='dayBlock';
    const del=document.createElement('button'); del.className='del-icon'; del.textContent='üóëÔ∏è'; del.onclick=()=>{delete current[key];openTurniEdit(current);}
    const p=document.createElement('input'); p.placeholder='Pranzo'; p.value=current[key].pranzo; p.oninput=e=>current[key].pranzo=e.target.value;
    const c=document.createElement('input'); c.placeholder='Cena';  c.value=current[key].cena;  c.oninput=e=>current[key].cena=e.target.value;
    const name=document.createElement('div'); name.innerHTML=`<strong>${key}</strong> `; name.appendChild(del);
    block.appendChild(name); block.appendChild(p); block.appendChild(c); edit.appendChild(block);
  });

  edit.classList.remove('hidden');
  save.onclick=async()=>{await setState({turni:current}); closeTurniEdit();}
}

function closeTurniEdit(){
  ['turniEdit','turniSave','turniSelect'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  document.getElementById('turniAddDay').classList.remove('hidden');
  document.getElementById('turniEditIcon').classList.remove('hidden');
  document.getElementById('turniView').classList.remove('hidden');
  render();
}

document.getElementById('prevDay').onclick = ()=>{
  currentTurnoIndex--;
  render();
};
document.getElementById('nextDay').onclick = ()=>{
  currentTurnoIndex++;
  render();
};

render();
setInterval(render,2000);
</script>
</body>
</html>
