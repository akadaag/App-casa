<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Stato Casa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {font-family: Arial,sans-serif;max-width:500px;margin:auto;padding:20px;}
    h1{text-align:center;margin-bottom:20px}
    .section{margin-bottom:28px;} /* spazio maggiore tra sezioni */
    .card{border:1px solid #ccc;padding:15px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.1);position:relative;font-size:18px;}
    .sectionTitle{display:flex;justify-content:space-between;align-items:center;font-weight:bold;}
    .edit-icon{border:none;background:none;font-size:19px;cursor:pointer;}
    .status-free{color:#28a745;font-weight:bold;}
    .status-occupied{color:#dc3545;font-weight:bold;}
    button{width:100%;padding:12px;font-size:17px;border:none;border-radius:8px;margin-top:10px;cursor:pointer;}
    .btn-use{background:#007bff;color:#fff;}
    .btn-free{background:#28a745;color:#fff;}
    .btn-choice{background:#6c757d;color:#fff;margin-top:5px;}
    .plus-btn{margin-top:10px;font-size:26px;border:none;background:none;cursor:pointer;}
    .del-icon{border:none;background:none;font-size:18px;cursor:pointer;margin-left:5px;}
    .hidden{display:none;}
    input{width:100%;padding:8px;border-radius:6px;margin:5px 0;}
    .dayBlock{margin-top:8px;}
  </style>
</head>
<body>
<h1>Stato Casa</h1>

<div class="section">
  <div id="bathroomSection"></div>
  <button id="useButton" class="btn-use">Usa un bagno</button>
  <div id="choiceButtons" class="hidden"></div>
  <button id="freeButton" class="btn-free hidden">Ho finito</button>
</div>

<div class="section card" id="menuCard">
 <div class="sectionTitle">
   <span>üçΩÔ∏è Menu</span>
   <button class="edit-icon" id="menuEditIcon">‚úèÔ∏è</button>
 </div>
 <div id="menuView"></div>
 <div id="menuEdit" class="hidden"></div>
 <button id="menuAddDay" class="plus-btn hidden">Ôºã</button>
 <button id="menuSave" class="btn-free hidden">Salva</button>
</div>

<div class="section card" id="turniCard">
  <div class="sectionTitle">
    <span>üßº Turni piatti</span>
    <button class="edit-icon" id="turniEditIcon">‚úèÔ∏è</button>
  </div>
  <div id="turniView"></div>
  <div id="turniEdit" class="hidden"></div>
  <button id="turniAddDay" class="plus-btn hidden">Ôºã</button>
  <button id="turniSave" class="btn-free hidden">Salva</button>
</div>

<script>
const PIN='6789';
const localKey='bagno_app_user';
let userId=localStorage.getItem(localKey);
if(!userId){ userId=Date.now()+Math.random(); localStorage.setItem(localKey,userId); }

async function getState(){return fetch('/api/state').then(r=>r.json());}
async function setState(d){return fetch('/api/state',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({...d,user:userId})});}

const giorni=["Luned√¨","Marted√¨","Mercoled√¨","Gioved√¨","Venerd√¨","Sabato","Domenica"];
function getNextDay(list){for(const g of giorni){if(!list.includes(g))return g;}return null;}

async function render(){
 const d=await getState();
 renderBagni(d);
 renderMenuView(d.menu);
 renderTurniView(d.turni);
}

function renderBagni(d){
 const cont=document.getElementById('bathroomSection'); cont.innerHTML='';
 ['sopra','sotto'].forEach(b=>{
  const occ=(d[b].state==='occupied');
  cont.innerHTML+=`<div class="card">üöΩ Bagno ${b} ‚Äî <span class="${occ?'status-occupied':'status-free'}">${occ?'Occupato':'Libero'}</span></div>`;
 });
 const useBtn=document.getElementById('useButton'), freeBtn=document.getElementById('freeButton'), choice=document.getElementById('choiceButtons');
 const myB=['sopra','sotto'].find(b=>d[b].state==='occupied'&&d[b].user===userId);
 choice.classList.add('hidden'); choice.innerHTML='';
 if(myB){ useBtn.classList.add('hidden'); freeBtn.classList.remove('hidden');
   freeBtn.onclick=async()=>{await setState({bagno:myB,state:'free'});render();}
 }else{
   freeBtn.classList.add('hidden'); useBtn.classList.remove('hidden');
   useBtn.onclick=()=>{ const f=['sopra','sotto'].filter(b=>d[b].state==='free');
     if(!f.length){alert('Tutti occupati');return;}
     choice.classList.remove('hidden'); choice.innerHTML='Seleziona bagno:<br>';
     f.forEach(b=>{const bt=document.createElement('button');bt.className='btn-choice';bt.textContent=b;bt.onclick=async()=>{await setState({bagno:b,state:'occupied'});render();};choice.appendChild(bt);});
   };
 }
}

// ---- MENU ----
function renderMenuView(menu){
 const view=document.getElementById('menuView'), icon=document.getElementById('menuEditIcon');
 view.innerHTML='';
 if(menu){
   Object.keys(menu).forEach(d=>{
     view.innerHTML+=`<div><strong>${d}</strong><br>‚Ä¢ Pranzo: ${menu[d].pranzo||'-'}<br>‚Ä¢ Cena: ${menu[d].cena||'-'}</div>`;
   });
 }else{ view.innerHTML='(vuoto)'; }
 icon.onclick=()=>{ if(prompt('PIN?')===PIN){ openMenuEdit(menu||{"Luned√¨":{pranzo:"",cena:""}}); } };
}

function openMenuEdit(current){
 document.getElementById('menuView').classList.add('hidden');
 document.getElementById('menuEditIcon').classList.add('hidden');
 const edit=document.getElementById('menuEdit'), add=document.getElementById('menuAddDay'), save=document.getElementById('menuSave');
 edit.innerHTML=''; add.classList.remove('hidden'); save.classList.remove('hidden');
 add.onclick=()=>{ const next=getNextDay(Object.keys(current)); if(next){current[next]={pranzo:'',cena:''}; openMenuEdit(current);} };
 Object.keys(current).forEach(d=>{
  const block=document.createElement('div');block.className='dayBlock';
  const del=document.createElement('button');del.className='del-icon';del.textContent='üóëÔ∏è';del.onclick=()=>{delete current[d];openMenuEdit(current);}
  block.appendChild(document.createTextNode(d)); block.appendChild(del);
  const p=document.createElement('input'); p.placeholder='Pranzo'; p.value=current[d].pranzo||''; p.oninput=e=>current[d].pranzo=e.target.value;
  const c=document.createElement('input'); c.placeholder='Cena'; c.value=current[d].cena||''; c.oninput=e=>current[d].cena=e.target.value;
  block.appendChild(document.createElement('br')); block.appendChild(p);
  block.appendChild(c); edit.appendChild(block);
 });
 edit.classList.remove('hidden');
 save.onclick=async()=>{ await setState({menu:current}); closeMenuEdit(); };
}
function closeMenuEdit(){ ['menuEdit','menuAddDay','menuSave'].forEach(id=>document.getElementById(id).classList.add('hidden'));
 document.getElementById('menuEditIcon').classList.remove('hidden');
 document.getElementById('menuView').classList.remove('hidden'); render();
}

// ---- TURNI ----
function renderTurniView(turni){
 const view=document.getElementById('turniView'), icon=document.getElementById('turniEditIcon');
 view.innerHTML='';
 if(turni){
   Object.keys(turni).forEach(d=>{
     view.innerHTML+=`<div><strong>${d}</strong><br>‚Ä¢ Pranzo: ${turni[d].pranzo||'-'}<br>‚Ä¢ Cena: ${turni[d].cena||'-'}</div>`;
   });
 } else { view.innerHTML='(vuoto)'; }
 icon.onclick=()=>{ if(prompt('PIN?')===PIN){ openTurniEdit(turni||{}); } };
}
function openTurniEdit(current){
 const view=document.getElementById('turniView'), icon=document.getElementById('turniEditIcon');
 const edit=document.getElementById('turniEdit'), add=document.getElementById('turniAddDay'), save=document.getElementById('turniSave');
 view.classList.add('hidden'); icon.classList.add('hidden');
 edit.innerHTML=''; add.classList.remove('hidden'); save.classList.remove('hidden');
 add.onclick=()=>{ const next=getNextDay(Object.keys(current)); if(next){current[next]={pranzo:'',cena:''}; openTurniEdit(current);} };
 Object.keys(current).forEach(d=>{
  const block=document.createElement('div'); block.className='dayBlock';
  const del=document.createElement('button'); del.className='del-icon'; del.textContent='üóëÔ∏è'; del.onclick=()=>{delete current[d];openTurniEdit(current);}
  block.appendChild(document.createTextNode(d)); block.appendChild(del);
  const p=document.createElement('input'); p.placeholder='Pranzo'; p.value=current[d].pranzo||''; p.oninput=e=>current[d].pranzo=e.target.value;
  const c=document.createElement('input'); c.placeholder='Cena'; c.value=current[d].cena||''; c.oninput=e=>current[d].cena=e.target.value;
  block.appendChild(document.createElement('br')); block.appendChild(p); block.appendChild(c); edit.appendChild(block);
 });
 edit.classList.remove('hidden');
 save.onclick=async()=>{ await setState({turni:current}); closeTurniEdit(); };
}
function closeTurniEdit(){ ['turniEdit','turniAddDay','turniSave'].forEach(id=>document.getElementById(id).classList.add('hidden'));
 document.getElementById('turniEditIcon').classList.remove('hidden');
 document.getElementById('turniView').classList.remove('hidden'); render();
}

render();
setInterval(render,5000);
</script>
</body>
</html>
