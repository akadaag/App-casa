<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Stato Casa</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  body{font-family:Arial,sans-serif;max-width:600px;margin:auto;padding:20px;}
  h1{text-align:center;margin-bottom:20px;}
  .section{margin-bottom:32px;}
  .card{padding:16px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.15);background:#fff;}
  .titleRow{display:flex;justify-content:space-between;align-items:center;font-size:20px;font-weight:bold;margin-bottom:8px;}
  .edit-icon{border:none;background:none;font-size:20px;cursor:pointer;}
  .status-free{color:#28a745;font-weight:bold;}
  .status-occupied{color:#dc3545;font-weight:bold;}
  .btn{width:100%;padding:13px;font-size:17px;border:none;border-radius:8px;cursor:pointer;}
  .btn-primary{background:#2196F3;color:#fff;}
  .btn-secondary{background:#4caf50;color:#fff;}
  .btn-choice{background:#607d8b;color:#fff;margin-top:8px;}
  .btn-icon{background:none;border:none;font-size:24px;cursor:pointer;margin-top:10px;}
  .hidden{display:none;}
  input,select{width:100%;padding:8px;border-radius:6px;margin:5px 0;}
  .dayBlock{margin-top:12px;}
  .navRow{display:flex;justify-content:space-between;margin-bottom:6px;}
</style>
</head>

<body>
<h1>Stato Casa</h1>

<div class="section">
  <div id="bathroomSection"></div>
  <button id="useButton" class="btn btn-primary">Usa un bagno</button>
  <div id="choiceButtons" class="hidden"></div>
  <button id="freeButton" class="btn btn-secondary hidden">Ho finito</button>
</div>

<div class="section card">
  <div class="titleRow"><span>üçΩÔ∏è Menu</span><button id="menuEditIcon" class="edit-icon">‚úèÔ∏è</button></div>
  <div id="menuView"></div>
  <div id="menuEdit" class="hidden"></div>
  <button id="menuAddDay" class="btn-icon hidden">Ôºã</button>
  <button id="menuSave" class="btn btn-secondary hidden">Salva</button>
</div>

<div class="section card">
  <div class="titleRow"><span>üßº Turni piatti</span><button id="turniEditIcon" class="edit-icon">‚úèÔ∏è</button></div>
  <div class="navRow">
    <button id="prevDay" class="edit-icon">‚óÄÔ∏è</button>
    <span id="currentDayTitle"></span>
    <button id="nextDay" class="edit-icon">‚ñ∂Ô∏è</button>
  </div>
  <div id="turniView"></div>
  <div id="turniEdit" class="hidden"></div>
  <button id="turniAddDay" class="btn-icon hidden">Ôºã</button>
  <button id="turniSave" class="btn btn-secondary hidden">Salva</button>
</div>

<script>
const PIN='6789';

async function getState(){
  return fetch('/api/state').then(r=>r.json());
}
async function setState(o){
  return fetch('/api/state',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(o)
  });
}

async function render(){
  const d = await getState();
  renderBagni(d);
  renderMenuView(d.menu);
  renderTurniView(d.turni);
}

// ----------- BAGNI ----------
function renderBagni(d){
  const cont=document.getElementById('bathroomSection'); cont.innerHTML='';
  ['sopra','sotto'].forEach(b=>{
    const occ=(d[b].state==='occupied');
    cont.innerHTML+=`<div class="card" style="margin-bottom:10px">üöΩ Bagno ${b} ‚Äî <span class="${occ?'status-occupied':'status-free'}">${occ?'Occupato':'Libero'}</span></div>`;
  });
  const use=document.getElementById('useButton'),
        free=document.getElementById('freeButton'),
        ch=document.getElementById('choiceButtons');
  const myB=['sopra','sotto'].find(b=>d[b].state==='occupied'&&d[b].user===d.user);
  ch.classList.add('hidden'); ch.innerHTML='';
  if(myB){ use.classList.add('hidden'); free.classList.remove('hidden');
    free.onclick=async()=>{ await setState({bagno:myB,state:'free'}); render(); };
  }else{
    free.classList.add('hidden'); use.classList.remove('hidden');
    use.onclick=()=>{
      const available=['sopra','sotto'].filter(b=>d[b].state==='free');
      if(!available.length){alert("Tutti occupati");return;}
      ch.classList.remove('hidden'); ch.innerHTML='Seleziona bagno:<br>';
      available.forEach(b=>{
        const btn=document.createElement('button');btn.className='btn btn-choice';
        btn.textContent=b; btn.onclick=async()=>{ await setState({bagno:b,state:'occupied'}); render(); };
        ch.appendChild(btn);
      });
    };
  }
}

// ----------- MENU ----------
function renderMenuView(menu){
  const view=document.getElementById('menuView'), icon=document.getElementById('menuEditIcon');
  view.innerHTML=menu?'':'(vuoto)';
  if(menu){
    Object.keys(menu).forEach(d=>{
      view.innerHTML+=`<div><strong>${d}</strong><br>‚Ä¢ Pranzo: ${menu[d].pranzo||'-'}<br>‚Ä¢ Cena: ${menu[d].cena||'-'}</div>`;
    });
  }
  icon.onclick=()=>{ if(prompt('PIN?')===PIN){ openMenuEdit(menu||{}); } };
}

function openMenuEdit(current){
  document.getElementById('menuView').classList.add('hidden');
  document.getElementById('menuEditIcon').classList.add('hidden');
  const edit=document.getElementById('menuEdit'), add=document.getElementById('menuAddDay'), save=document.getElementById('menuSave');
  edit.innerHTML='';
  add.classList.remove('hidden'); save.classList.remove('hidden');

  Object.keys(current).forEach(day=>{
    const block=document.createElement('div'); block.className='dayBlock';
    const del=document.createElement('button'); del.className='del-icon'; del.textContent='üóëÔ∏è'; del.onclick=()=>{ delete current[day]; openMenuEdit(current); };
    const p=document.createElement('input'); p.placeholder='Pranzo'; p.value=current[day].pranzo; p.oninput=e=>current[day].pranzo=e.target.value;
    const c=document.createElement('input'); c.placeholder='Cena';  c.value=current[day].cena;  c.oninput=e=>current[day].cena=e.target.value;
    const title=document.createElement('div'); title.innerHTML=`<strong>${day}</strong>`; title.appendChild(del);
    block.appendChild(title); block.appendChild(p); block.appendChild(c);
    edit.appendChild(block);
  });

  add.onclick=()=>{
    const newDay=prompt('Inserisci il giorno (es: Luned√¨, Marted√¨...)');
    if(newDay){
      current[newDay]={pranzo:'',cena:''};
      openMenuEdit(current);
    }
  };

  edit.classList.remove('hidden');
  save.onclick=async()=>{ await setState({menu:current}); closeMenuEdit(); };
}

function closeMenuEdit(){
  document.getElementById('menuEdit').classList.add('hidden');
  document.getElementById('menuSave').classList.add('hidden');
  document.getElementById('menuAddDay').classList.add('hidden');
  document.getElementById('menuEditIcon').classList.remove('hidden');
  document.getElementById('menuView').classList.remove('hidden');
  render();
}

// ---------- TURNI ----------
let turniIndex = 0;

function renderTurniView(turni){
  const view=document.getElementById('turniView'),
        icon=document.getElementById('turniEditIcon'),
        prev=document.getElementById('prevDay'),
        next=document.getElementById('nextDay'),
        title=document.getElementById('currentDayTitle');
  const keys = Object.keys(turni||{});
  view.innerHTML='';
  if(keys.length===0){
    view.innerHTML='Nessun turno inserito';
    prev.style.display='none'; next.style.display='none'; title.innerText='';
  } else {
    if(turniIndex<0) turniIndex=0;
    if(turniIndex>=keys.length) turniIndex=keys.length-1;
    const k=keys[turniIndex];
    const t=turni[k];
    view.innerHTML=`<div><strong>${k}</strong><br>‚Ä¢ Pranzo: ${t.pranzo||'-'}<br>‚Ä¢ Cena: ${t.cena||'-'}</div>`;
    title.innerText=`${turniIndex+1} / ${keys.length}`;
    prev.style.display='inline'; next.style.display='inline';
  }
  prev.onclick=()=>{turniIndex--; render();};
  next.onclick=()=>{turniIndex++; render();};
  icon.onclick=()=>{ if(prompt('PIN?')===PIN){ openTurniEdit(turni||{}); } };
}

function openTurniEdit(current){
  document.getElementById('turniView').classList.add('hidden');
  document.getElementById('turniEditIcon').classList.add('hidden');
  const edit=document.getElementById('turniEdit'),
        add=document.getElementById('turniAddDay'),
        save=document.getElementById('turniSave');
  edit.innerHTML='';
  add.classList.remove('hidden'); save.classList.remove('hidden');
  Object.keys(current).forEach(k=>{
    const block=document.createElement('div'); block.className='dayBlock';
    const del=document.createElement('button'); del.className='del-icon'; del.textContent='üóëÔ∏è'; del.onclick=()=>{ delete current[k]; openTurniEdit(current); };
    const p=document.createElement('input'); p.placeholder='Pranzo'; p.value=current[k].pranzo; p.oninput=e=>current[k].pranzo=e.target.value;
    const c=document.createElement('input'); c.placeholder='Cena';  c.value=current[k].cena;  c.oninput=e=>current[k].cena=e.target.value;
    const t=document.createElement('div'); t.innerHTML=`<strong>${k}</strong>`; t.appendChild(del);
    block.appendChild(t); block.appendChild(p); block.appendChild(c);
    edit.appendChild(block);
  });
  add.onclick=()=>{
    const newDay=prompt('Inserisci il giorno (es: Luned√¨, Marted√¨...)');
    if(newDay){ current[newDay]={pranzo:'',cena:''}; openTurniEdit(current); }
  };
  edit.classList.remove('hidden');
  save.onclick=async()=>{ await setState({turni:current}); closeTurniEdit(); };
}

function closeTurniEdit(){
  document.getElementById('turniEdit').classList.add('hidden');
  document.getElementById('turniSave').classList.add('hidden');
  document.getElementById('turniAddDay').classList.add('hidden');
  document.getElementById('turniEditIcon').classList.remove('hidden');
  document.getElementById('turniView').classList.remove('hidden');
  render();
}

render();
setInterval(render,5000);
</script>
</body>
</html>
